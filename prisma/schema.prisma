generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // hashed — null for OAuth users
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Auth
  accounts      Account[]
  sessions      Session[]

  // Relocation profile
  profile       Profile?
  journeys      Journey[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// User's relocation profile — collected during onboarding
model Profile {
  id               String   @id @default(cuid())
  userId           String   @unique
  nationality      String
  secondNationality String?
  originCountry    String
  destinationCountry String
  employmentStatus String   // employed | self_employed | freelancer | unemployed
  familyStatus     String   // single | couple | family_with_kids
  hasChildren      Boolean  @default(false)
  movingDate       DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// A relocation journey = one user's full move from A to B
model Journey {
  id          String   @id @default(cuid())
  userId      String
  title       String
  origin      String
  destination String
  status      JourneyStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks JourneyTask[]
}

enum JourneyStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

// A task within a journey (instance, with completion state)
model JourneyTask {
  id          String     @id @default(cuid())
  journeyId   String
  taskId      String?    // NULL for custom tasks
  status      TaskStatus @default(PENDING)
  completedAt DateTime?
  notes       String?
  phase       String     @default("POST_ARRIVAL") // PRE_DEPARTURE | POST_ARRIVAL
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // AI-enriched content — overrides template fields when present
  aiInstructions String?  // personalised step-by-step instructions
  aiDocuments    String[] // personalised document list
  aiTips         String?  // personalised tip
  aiGeneratedAt  DateTime? // when AI content was last fetched

  // Custom task fields — only set when taskId is NULL
  customTitle       String?
  customDescription String?
  customCategory    String?

  journey  Journey       @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  template TaskTemplate? @relation(fields: [taskId], references: [id])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// Reusable task definitions (the knowledge base)
model TaskTemplate {
  id           String   @id @default(cuid())
  title        String
  description  String
  category     String   // housing | banking | legal | telecom | transport | insurance | documents | moving | pets
  phase        String   @default("POST_ARRIVAL") // PRE_DEPARTURE | POST_ARRIVAL
  officialUrl  String?
  documents    String[] // list of required documents
  tips         String?
  order        Int      // display order within category

  // Which countries this task applies to
  countries    String[] // empty = applies to all

  // Dependency: this task should be done after these task IDs
  dependsOn    String[]

  // AI readiness flag — marks templates designed for LLM enrichment
  aiEnriched   Boolean  @default(false)

  // Per-combination skeleton — empty = applies to all
  nationalities      String[]  @default([])
  originCountries    String[]  @default([])
  employmentStatuses String[]  @default([])
  familyStatuses     String[]  @default([])

  journeyTasks JourneyTask[]
}
